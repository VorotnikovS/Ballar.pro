<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Ballar ‚Äî Rive Site</title>
  <script src="https://unpkg.com/@rive-app/webgl"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background-color: black;
    }

    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <canvas id="rive-canvas"></canvas>

  <script>
    const canvas = document.getElementById("rive-canvas");
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const riveFile = isMobile ? "ballar_mobile.riv" : "ballar.riv";

    const dpr = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpr;
    canvas.height = window.innerHeight * dpr;
    canvas.style.width = "100vw";
    canvas.style.height = "100vh";

    let scrollYInput;
    let goToWWInput;
    let goToMathInput;
    let ButtonBackInput;
    let goAppStoreWWInput;
    let GoGooglePlayMathInput;
    let GoAppStoreMathInput;

    const riveInstance = new rive.Rive({
      src: riveFile,
      canvas: canvas,
      autoplay: true,
      artboard: "Ballar",
      stateMachines: ["State Machine 1"],
      layout: new rive.Layout({
        fit: rive.Fit.FitWidth,
        alignment: rive.Alignment.TopCenter
      }),
      onLoad: () => {
        console.log("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª:", riveFile);

        const inputs = riveInstance.stateMachineInputs("State Machine 1");

        const sizeInput = inputs.find(i => i.name === "Size");
        if (sizeInput) sizeInput.value = window.innerWidth;

        scrollYInput = inputs.find(i => i.name === "ScrollY");
        goToWWInput = inputs.find(i => i.name === "GoToWW");
        goToMathInput = inputs.find(i => i.name === "goToMath");
        ButtonBackInput = inputs.find(i => i.name === "ButtonBack");
        goAppStoreWWInput = inputs.find(i => i.name === "GoAppStoreWW");
        GoGooglePlayMathInput = inputs.find(i => i.name === "GoGooglePlayMath");
        GoAppStoreMathInput = inputs.find(i => i.name === "GoAppStoreMath");

        monitorTriggerFlag();
      },
      onError: (err) => console.error("‚ùå –û—à–∏–±–∫–∞ Rive:", err)
    });

    // üì± –ú–æ–±–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞: —Å–≤–∞–π–ø—ã
    if (isMobile) {
  let lastY = null;
  let scrollVelocity = 0;
  const damping = 0.9; // 0.9 ‚Äî —Å–∏–ª—å–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ, 0.95 ‚Äî –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–µ

  window.addEventListener("touchmove", (e) => {
    if (!scrollYInput) return;
    if (lastY === null) {
      lastY = e.touches[0].clientY;
      return;
    }

    const deltaY = lastY - e.touches[0].clientY;
    scrollVelocity = deltaY * 1.5; // —Å–∏–ª–∞ "—É–¥–∞—Ä–∞" —Å–≤–∞–π–ø–∞
    lastY = e.touches[0].clientY;
  });

  window.addEventListener("touchend", () => {
    lastY = null;
  });

  // –¶–∏–∫–ª, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω–µ—Ä—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
  function scrollLoopMobile() {
    if (scrollYInput && Math.abs(scrollVelocity) > 0.1) {
      scrollYInput.value += scrollVelocity;
      scrollYInput.value = Math.max(0, Math.min(4000, scrollYInput.value));
      scrollVelocity *= damping;
    }
    requestAnimationFrame(scrollLoopMobile);
  }

  requestAnimationFrame(scrollLoopMobile);


    // üñ• –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –ª–æ–≥–∏–∫–∞: –∫–æ–ª–µ—Å–æ –º—ã—à–∏
    } else {
      window.addEventListener("wheel", (e) => {
        if (!scrollYInput) return;
        scrollYInput.value += e.deltaY * 0.3;
        scrollYInput.value = Math.max(0, Math.min(4000, scrollYInput.value));
      });
    }

    // üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
    function monitorTriggerFlag() {
      if (goToWWInput?.value) {
        console.log("üéØ Trigger GoToWW");
        goToWWInput.value = false;
        animateScrollYTo(1285);
      }

      if (goToMathInput?.value) {
        console.log("üéØ Trigger goToMath");
        goToMathInput.value = false;
        animateScrollYTo(2474);
      }

      if (ButtonBackInput?.value) {
        console.log("üîô Back");
        ButtonBackInput.value = false;
        animateScrollYTo(0);
      }

      if (goAppStoreWWInput?.value) {
        console.log("üåê –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ App Store WW");
        goAppStoreWWInput.value = false;
        window.open("https://apps.apple.com/ru/app/wake-the-world-my-map/id1529898421?l=en-GB", "_blank");
      }

      if (GoGooglePlayMathInput?.value) {
        console.log("üåê –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Google Play");
        GoGooglePlayMathInput.value = false;
        window.open("", "_blank");
      }

      if (GoAppStoreMathInput?.value) {
        console.log("üåê –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ App Store Math");
        GoAppStoreMathInput.value = false;
        window.open("https://apps.apple.com/us/app/math-game-mental-mastery/id6745556295", "_blank");
      }

      requestAnimationFrame(monitorTriggerFlag);
    }

    function animateScrollYTo(targetValue) {
      const duration = 600;
      const startValue = scrollYInput.value;
      const startTime = performance.now();

      function step(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = easeInOutQuad(progress);
        scrollYInput.value = startValue + (targetValue - startValue) * eased;
        if (progress < 1) requestAnimationFrame(step);
      }

      requestAnimationFrame(step);
    }

    function easeInOutQuad(t) {
      return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
    }
  </script>
</body>
</html>
