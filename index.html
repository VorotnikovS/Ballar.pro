<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Ballar ‚Äî Rive Site</title>
  <script src="https://unpkg.com/@rive-app/webgl"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background-color: black;
    }

    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <canvas id="rive-canvas"></canvas>

  <script>
    const canvas = document.getElementById("rive-canvas");
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const riveFile = isMobile ? "ballar_mobile.riv" : "ballar.riv";

    const dpr = isMobile ? 1 : window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpr;
    canvas.height = window.innerHeight * dpr;
    canvas.style.width = "100vw";
    canvas.style.height = "100vh";

    let scrollYInput;
    let goToWWInput;
    let goToMathInput;
    let ButtonBackInput;
    let goAppStoreWWInput;
    let GoGooglePlayMathInput;
    let GoAppStoreMathInput;
    let velocityY = 0;
    let isTouching = false;


    const riveInstance = new rive.Rive({
      src: riveFile,
      canvas: canvas,
      autoplay: true,
      artboard: "Ballar",
      stateMachines: ["State Machine 1"],
      layout: new rive.Layout({
        fit: rive.Fit.FitWidth,
        alignment: rive.Alignment.TopCenter
      }),
      onLoad: () => {
        console.log("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª:", riveFile);

        const inputs = riveInstance.stateMachineInputs("State Machine 1");

        const sizeInput = inputs.find(i => i.name === "Size");
        if (sizeInput) sizeInput.value = window.innerWidth;

        scrollYInput = inputs.find(i => i.name === "ScrollY");
        goToWWInput = inputs.find(i => i.name === "GoToWW");
        goToMathInput = inputs.find(i => i.name === "goToMath");
        ButtonBackInput = inputs.find(i => i.name === "ButtonBack");
        goAppStoreWWInput = inputs.find(i => i.name === "GoAppStoreWW");
        GoGooglePlayMathInput = inputs.find(i => i.name === "GoGooglePlayMath");
        GoAppStoreMathInput = inputs.find(i => i.name === "GoAppStoreMath");

        monitorTriggerFlag();
      },
      onError: (err) => console.error("‚ùå –û—à–∏–±–∫–∞ Rive:", err)
    });

    // üì± –ú–æ–±–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞: —Å–≤–∞–π–ø—ã
    if (isMobile) {
      let lastY = null;

      window.addEventListener("touchmove", (e) => {
        if (!scrollYInput) return;
        if (lastY === null) {
          lastY = e.touches[0].clientY;
          return;
        }
        const deltaY = lastY - e.touches[0].clientY;
        velocityY = deltaY * 2;
        scrollYInput.value += velocityY;
        scrollYInput.value = Math.max(0, Math.min(4000, scrollYInput.value));
        lastY = e.touches[0].clientY;
        isTouching = true;
      });

      window.addEventListener("touchend", () => {
        lastY = null;
        isTouching = false;
      });

    // üñ• –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –ª–æ–≥–∏–∫–∞: –∫–æ–ª–µ—Å–æ –º—ã—à–∏
    } else {
      window.addEventListener("wheel", (e) => {
        if (!scrollYInput) return;
        scrollYInput.value += e.deltaY * 0.3;
        scrollYInput.value = Math.max(0, Math.min(4000, scrollYInput.value));
      });
    }

    // üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
    function monitorTriggerFlag() {
      if (goToWWInput?.value) {
        console.log("üéØ Trigger GoToWW");
        goToWWInput.value = false;
        animateScrollYTo(1285);
      }

      if (goToMathInput?.value) {
        console.log("üéØ Trigger goToMath");
        goToMathInput.value = false;
        animateScrollYTo(2474);
      }

      if (ButtonBackInput?.value) {
        console.log("üîô Back");
        ButtonBackInput.value = false;
        animateScrollYTo(0);
      }

      if (goAppStoreWWInput?.value) {
        console.log("üåê –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ App Store WW");
        goAppStoreWWInput.value = false;
        window.open("https://apps.apple.com/ru/app/wake-the-world-my-map/id1529898421?l=en-GB", "_blank");
      }

      if (GoGooglePlayMathInput?.value) {
        console.log("üåê –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Google Play");
        GoGooglePlayMathInput.value = false;
        window.open("", "_blank");
      }

      if (GoAppStoreMathInput?.value) {
        console.log("üåê –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ App Store Math");
        GoAppStoreMathInput.value = false;
        window.open("https://apps.apple.com/us/app/math-game-mental-mastery/id6745556295", "_blank");
      }
      
      updateInertia();

      if (Math.abs(velocityY) > 0.1 || goToWWInput?.value || goToMathInput?.value || ButtonBackInput?.value) {
        requestAnimationFrame(monitorTriggerFlag);
      }

    }

    function updateInertia() {
      if (!scrollYInput || isTouching) return;

      if (Math.abs(velocityY) > 0.1) {
        scrollYInput.value += velocityY;
        scrollYInput.value = Math.max(0, Math.min(4000, scrollYInput.value));
        velocityY *= 0.95; // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–º–µ–¥–ª–µ–Ω–∏—è (0.90‚Äì0.98 = –ø–ª–∞–≤–Ω–µ–µ)
      } else {
        velocityY = 0;
      }
    }


    function animateScrollYTo(targetValue) {
      const duration = 600;
      const startValue = scrollYInput.value;
      const startTime = performance.now();

      function step(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = easeInOutQuad(progress);
        scrollYInput.value = startValue + (targetValue - startValue) * eased;
        if (progress < 1) requestAnimationFrame(step);
      }

      requestAnimationFrame(step);
    }

    function easeInOutQuad(t) {
      return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
    }
  </script>
</body>
</html>
